<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>cve searcher</title>
<style>
body {
    margin: 50px 100px;
}
.formdiv {
  width: 300px;
  margin: 0 auto;
}
input {
  border: 1px solid transparent;
  background-color: #f1f1f1;
  padding: 10px;
  font-size: 16px;
}
input[type=text] {
  background-color: #f1f1f1;
  width: 100%;
}
input[type=submit] {
  background-color: DodgerBlue;
  color: #fff;
}
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  padding: 15px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}
tr:hover {background-color: #f5f5f5;}
</style>
</head>
<body>

<div class="formdiv">
  <form autocomplete="off">
    <input id="myInput" type="text" name="myCountry" placeholder="component" autofocus>
    <!-- <input type="submit"> -->
  </form>
</div>
<br><br><br>
<div id="reportdiv">
</div>

<script>
  var cves=Object.create(null)
  
  fetch('allitems.txt', {mode: 'no-cors'})
    .then(response => response.text())
    .then(console.log("fetch complete"))
    .then(text => text.split("======================================================"))
    .then(console.log("split complete"))
    .then(text => {
      for (var i=1;i<text.length;i++){
        // var msg = /[\s\S]+?\n\n([\s\S]+?)\n\n[\s\S]*?/.exec(text[i]);
        var msg = /\nName: ([^\n]+)\n[\s\S]+?\n\n([\s\S]+?)\n\n[\s\S]*?/.exec(text[i]);
        if (msg){
          cves[msg[1]]=msg[2].replace(/\n/g," ");
        } else {
          console.error("didnt match")
          console.log(i)
          console.log(text[i])
        }
        // var clean_a = text[i].split("Current Votes")[0];
        // var clean_b = clean_a.split("ooooooooo");
        // console.log(clean_b);
      }
    })

    function search(inStr){
      return Object.entries(cves).filter( cve => cve[1].toLowerCase().indexOf(inStr.toLowerCase())!=-1);
    }

    function search_ver(inStr, version){
      return Object.entries(cves).filter( function (cve){
        var lcase = cve[1].toLowerCase();
        var namecheck = lcase.indexOf(inStr.toLowerCase())!=-1;
        var vercheck = false;
        if (lcase.indexOf(inStr + " " + version)!=-1){
          vercheck = true;
        } else if (lcase.indexOf(" in ")!=-1){
          var keypiece = lcase.split(" in ")[1];
          if (keypiece.indexOf(" before ")!=-1){
            let keypiece2 = keypiece.split(" before ");
            namecheck = keypiece2[0].indexOf(inStr)!=-1;
            let cleanedVersion = keypiece2[1].split(/[\s,]+/)[0].replace(/[^\d.-]/g, '');
            vercheck = compareVersionNumbers(version,cleanedVersion)<=0;
          } else {
            // todo: versions x through x
            let cleanedVersion = keypiece.split(/[\s,]+/)[0].replace(/[^\d.-]/g, '');
            vercheck = compareVersionNumbers(version,cleanedVersion)===0;
          }
        } else if (lcase.indexOf(" before ")!=-1){
          let keypiece2 = lcase.split(" before ");
          namecheck = keypiece2[0].indexOf(inStr)!=-1;
          let cleanedVersion = keypiece2[1].split(/[\s,]+/)[0].replace(/[^\d.-]/g, '');
          vercheck = compareVersionNumbers(version,cleanedVersion)<=0;
        }
        return namecheck && vercheck;
      })
    }

    function compareVersionNumbers(v1, v2){ // https://stackoverflow.com/questions/6832596/how-to-compare-software-version-number-using-js-only-number
      var v1parts = v1.split('.');
      var v2parts = v2.split('.');

      function isPositiveInteger(x) { // http://stackoverflow.com/a/1019526/11236
        return /^\d+$/.test(x);
      }
      // First, validate both numbers are true version numbers
      function validateParts(parts) {
          for (var i = 0; i < parts.length; ++i) {
              if (!isPositiveInteger(parts[i])) {
                  return false;
              }
          }
          return true;
      }
      if (!validateParts(v1parts) || !validateParts(v2parts)) {
          return NaN;
      }

      for (var i = 0; i < v1parts.length; ++i) {
          if (v2parts.length === i) {
              return 1;
          }

          if (v1parts[i] === v2parts[i]) {
              continue;
          }
          if (v1parts[i] > v2parts[i]) {
              return 1;
          }
          return -1;
      }

      if (v1parts.length != v2parts.length) {
          return -1;
      }

      return 0;
    }

    function report(inStr,limit=100){
      console.log(inStr)
      var target = document.getElementById("reportdiv");
      target.innerHTML = "";

      var trysplit = /(.+)\s(\.?\d[^\s]*)$/.exec(inStr);
      var filtered;
      if (trysplit){
        filtered = search_ver(trysplit[1], trysplit[2]);
      } else {
        filtered = search(inStr);
      }
      // console.log(filtered);
      if (filtered.length>0){
        var tbl = document.createElement('table');
        var tbody = document.createElement('tbody');
        var numRows = 0;
        for (var cve of filtered) {
          var tr = document.createElement('tr');

          var td = document.createElement('td');
          td.appendChild(document.createTextNode(cve[0]))
          tr.appendChild(td);

          var td2 = document.createElement('td');
          td2.appendChild(document.createTextNode(cve[1]))
          tr.appendChild(td2);

          tbody.appendChild(tr);

          numRows += 1;
          if (numRows>=limit) break;
        }

        tbl.appendChild(tbody);
        target.appendChild(tbl);
      } else {
        target.appendChild(document.createTextNode("No matching cves found."));
      }
    }
    
    document.getElementById("myInput").addEventListener("keydown", function(e) {
      if (e.keyCode == 13) {
        /*If the ENTER key is pressed, prevent the form from being submitted,*/
        e.preventDefault();
        if (document.getElementById("myInput").value.length<3){
          document.getElementById("reportdiv").innerHTML = "";
          return;
        };
        report(document.getElementById("myInput").value);
      }
    });

</script>

</body>
</html>